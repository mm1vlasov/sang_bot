# Аналитика бота SANG (кадровый аудит)

## 1. Текущая архитектура

| Компонент | Назначение |
|-----------|------------|
| **bot.js** | Точка входа, регистрация слэш-команд, проверка ролей, маршрутизация взаимодействий |
| **utils.js** | Общие хелперы: валидация паспорта, эмбеды, отправка в каналы аудита, автоудаление ответов |
| **commands/** | 5 слэш-команд: invite, uninvite, uprank, downrank, transfer |
| **resign.js** | Рапорт на увольнение: модалка, сбор фото, кнопки одобрения/отклонения, авто-uninvite |
| **promotion.js** | Запрос на повышение: модалка, кнопки одобрения/отклонения, авто-uprank в канал |
| **config.json** | Токен, каналы, роли (в т.ч. inviteRoles) |
| **ROLES.md** | Документация ролей (для людей; бот читает только config) |

**Плюсы:** модульность, единый стиль эмбедов и ответов, роли и каналы вынесены в конфиг.

---

## 2. Безопасность

### Критично

- **Токен в config.json** — при попадании репозитория в публичный доступ токен утекает.  
  **Рекомендация:** хранить токен в переменной окружения (`process.env.DISCORD_TOKEN`) и добавить `config.json` в `.gitignore`; в репозитории оставить `config.example.json` без токена.

### Важно

- **Нет .gitignore** — в коммит могут попасть `node_modules`, `config.json` с токеном.  
  **Рекомендация:** добавить `.gitignore` с минимум: `node_modules/`, `config.json`, `.env`.

---

## 3. Потенциальные баги и несоответствия

| Проблема | Где | Рекомендация |
|----------|-----|---------------|
| **downrank отправляет в канал uprank** | `commands/downrank.js` — `sendToAuditChannel(interaction, 'uprank', ...)` | Если понижение должно идти в отдельный канал — добавить в config `channels.downrank` и использовать его. Если один канал для обоих — оставить как есть, но переименовать параметр в `audit` или оставить комментарий в коде. |
| **Участник не на сервере** | invite / uninvite / transfer | При выборе пользователя, который вышел с сервера, `getMember('кого')` может вернуть `null` — роли не выдаются/не снимаются, но аудит всё равно отправляется. Имеет смысл явно предупреждать: «Пользователь не на сервере, роли не изменены.» |
| **Дублирование isValidPassport** | `utils.js` и `resign.js` | Оставить одну реализацию в `utils.js` и импортировать в `resign.js`. |
| **Дублирование getDisplayName** | `utils.js`, `resign.js`, `promotion.js` | В resign/promotion использовать `getDisplayName` из `utils.js`. |

---

## 4. Улучшения кода и единообразие

- **Роли из config везде** — в `resign.js` и `promotion.js` захардкожены `ROLE_SANG`, `ROLE_SENIOR_APPROVE`; при этом уже есть `config.roles.*`. Имеет смысл везде брать ID из config, а константы оставить только как fallback (или убрать).
- **Единый формат ответов об ошибках** — вынести тексты («Не удалось получить данные пользователя», «Номер паспорта должен содержать только цифры» и т.д.) в константы или один модуль `messages.js` — проще менять формулировки и добавлять локализацию потом.
- **DEPARTMENTS в utils.js** — не используется (в transfer теперь выбор ролей). Можно удалить или перенести в config, если понадобится для других фич.
- **scheduleReplyDelete после .catch(() => {})** — в нескольких местах после `interaction.reply(...).catch(() => {})` вызывается `scheduleReplyDelete(interaction)`. Если reply выбросил, ответа нет и deleteReply может дать ошибку (она глушится внутри). Лучше: `const replied = await interaction.reply(...).catch(() => null); if (replied) scheduleReplyDelete(interaction);` — так не вызываем delete для несуществующего ответа.

---

## 5. Функциональные улучшения

- **Одобрение рапорта на увольнение — снятие ролей**  
  Сейчас при одобрении отправляется только сообщение в канал uninvite. Имеет смысл при нажатии «Одобрить» дополнительно снимать у заявителя все роли (как в /uninvite), чтобы увольнение было не только на бумаге, но и в Discord.

- **Таймаут ожидания фото (resign)**  
  60 секунд — нормально; можно вынести в config (`resignPhotoCollectorTimeoutMs`) для гибкости.

- **Повторная отправка setup-сообщений**  
  При каждом перезапуске проверяется «есть ли уже сообщение с кнопкой» в канале. Если сообщение удалили вручную, при следующем рестарте бот отправит новое — ок. Можно добавить команду для админа «отправить setup снова» без перезапуска.

- **Логирование**  
  Сейчас только `console.error` в catch. Имеет смысл добавить простое логирование важных действий (кто кого принял/уволил/повысил, одобрения рапортов) в один канал или в файл — для аудита и разбора инцидентов.

- **Подтверждение опасных действий**  
  Для /uninvite (снятие всех ролей) и, по желанию, для «Одобрить с занесением в ЧС» можно показывать кнопку «Подтвердить» перед выполнением, чтобы уменьшить случайные нажатия.

---

## 6. Надёжность и производительность

- **Pending-данные в памяти**  
  `pendingResign`, `pendingResignByMessage`, `pendingPromotion` — при перезапуске бота все ожидающие фото и «незакрытые» запросы пропадают. Для продакшена с редкими рестартами это приемлемо; при частых рестартах можно перенести в Redis/БД (это уже масштабное изменение).

- **Регистрация команд при каждом Ready**  
  Команды перерегистрируются при каждом запуске — так и задумано для гильдии. Для стабильности можно регистрировать только при `guildId` и не чистить глобальные команды лишний раз, если бот один на гильдию.

- **Fetch каналов**  
  При Ready делается fetch каналов resign и promotion — при их удалении бот может выдать ошибку в консоль; обработка уже есть через `.catch(() => null)`.

---

## 7. Конфигурация и документация

- **config.example.json**  
  Создать пример конфига с пустыми/фейковыми значениями и комментариями (какой ID за что). Так новые развёртывания не будут копировать рабочий config с токеном.

- **README.md**  
  Кратко: как установить зависимости, как задать `DISCORD_TOKEN`, как запустить (`npm start`), что настроить в config (каналы, роли). Упоминание ROLES.md и ANALYTICS.md.

- **ROLES.md**  
  Уже указано, что источник правды — config.json; при добавлении новых ролей в бота стоит дублировать описание в ROLES.md.

---

## 8. Приоритетный список доработок

| № | Действие | Важность |
|---|----------|----------|
| 1 | Вынести токен в `process.env`, добавить `.gitignore`, создать `config.example.json` | Критично (безопасность) |
| 2 | При одобрении рапорта на увольнение дополнительно снимать все роли у заявителя | Высокая (консистентность с /uninvite) |
| 3 | Убрать дублирование `isValidPassport` и `getDisplayName` (использовать utils) | Средняя (поддержка) |
| 4 | Решить: один канал для uprank/downrank или отдельный для downrank; при отдельном — добавить `channels.downrank` | Средняя |
| 5 | Если пользователь не на сервере (invite/uninvite/transfer) — явное сообщение «Пользователь не на сервере, роли не изменены» | Средняя (UX) |
| 6 | Добавить README.md с установкой и настройкой | Низкая (онбординг) |
| 7 | Единый модуль текстов ответов (по желанию) | Низкая |

---

Итог: бот логично устроен, конфиг и роли централизованы. Главные риски — токен в репозитории и отсутствие .gitignore. Остальное — улучшения согласованности с /uninvite, чистоты кода и удобства сопровождения.
