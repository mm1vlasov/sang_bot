# Подробный гайд по использованию и настройке бота SANG (кадровый аудит)

Этот документ описывает, как установить бота, как его настроить (роли, каналы, выдача ролей) и как им пользоваться в повседневной работе.

---

## Содержание

1. [Что делает бот](#1-что-делает-бот)
2. [Требования](#2-требования)
3. [Установка](#3-установка)
4. [Создание приложения и бота в Discord](#4-создание-приложения-и-бота-в-discord)
5. [Как получить ID (гильдия, каналы, роли)](#5-как-получить-id-гильдия-каналы-роли)
6. [Файл config.json — полное описание](#6-файл-configjson--полное-описание)
7. [Настройка ролей — кто что может](#7-настройка-ролей--кто-что-может)
8. [Настройка каналов](#8-настройка-каналов)
9. [Настройка ролей при приёме (invite)](#9-настройка-ролей-при-приёме-invite)
10. [Использование команд](#10-использование-команд)
11. [Рапорт на увольнение и запрос на повышение](#11-рапорт-на-увольнение-и-запрос-на-повышение)
12. [Частые проблемы и решение](#12-частые-проблемы-и-решение)
13. [Безопасность (токен)](#13-безопасность-токен)

---

## 1. Что делает бот

Бот предназначен для кадрового учёта в Discord-сервере организации SANG:

- **Слэш-команды** (доступны только определённым ролям):
  - `/invite` — принять человека в организацию (выдать роли SANG и Academy, отправить запись в канал аудита).
  - `/uninvite` — уволить (снять все роли, отправить запись в канал аудита).
  - `/uprank` — повышение по рангу (запись в канал).
  - `/downrank` — понижение по рангу (запись в канал).
  - `/transfer` — перевод из одного отдела в другой (смена ролей, запись в канал).

- **Рапорт на увольнение** — в специальном канале пользователь с ролью SANG нажимает кнопку, заполняет форму, прикладывает фото. Старший состав одобряет или отклоняет; при одобрении автоматически отправляется «увольнение» в канал аудита и (по желанию) можно добавить снятие ролей у заявителя.

- **Запрос на повышение** — в отдельном канале пользователь с ролью SANG подаёт запрос; Старший состав одобряет или отклоняет. При одобрении автоматически отправляется запись о повышении в канал аудита.

Всё настраивается через один файл — **`config.json`** (роли, каналы, какие роли выдавать при приёме).

---

## 2. Требования

- **Node.js** версии 18 или выше (проверка: в терминале `node -v`).
- Аккаунт Discord и права администратора на сервере (или право «Управление сервером»), чтобы пригласить бота и настроить каналы/роли.
- Бот добавлен на сервер с правами, которые указаны в разделе про приглашение бота.

---

## 3. Установка

1. Скопируйте папку с ботом на компьютер (или клонируйте репозиторий).
2. Откройте терминал (командную строку) в папке бота.
3. Выполните:
   ```bash
   npm install
   ```
4. Создайте файл **`config.json`** в корне папки бота (скопируйте структуру из раздела 6 и заполните своими данными).
5. Запуск:
   ```bash
   npm start
   ```
   или
   ```bash
   node bot.js
   ```

В консоли должно появиться сообщение вида: `ИмяБота запустился!` и «Слэш-команды зарегистрированы для гильдии».

---

## 4. Создание приложения и бота в Discord

Если бот ещё не создан:

1. Зайдите на [Discord Developer Portal](https://discord.com/developers/applications).
2. Нажмите **New Application**, введите имя (например, «SANG Кадры») и создайте приложение.
3. В левом меню откройте **Bot**.
4. Нажмите **Add Bot**. Скопируйте **Token** — это значение нужно будет вписать в `config.json` в поле `token` (см. раздел 13 про безопасность).
5. В разделе **Privileged Gateway Intents** включите при необходимости:
   - **Presence Intent** — можно выключить, если не нужна активность пользователей.
   - **Server Members Intent** — желательно включить, чтобы бот видел участников и роли.
   - **Message Content Intent** — можно включить, если планируете читать текст сообщений.

6. В левом меню откройте **OAuth2 → URL Generator**:
   - **Scopes:** отметьте `bot`.
   - **Bot Permissions:** отметьте минимум:
     - Read Messages/View Channels
     - Send Messages
     - Embed Links
     - Attach Files
     - Read Message History
     - Manage Roles
   - Скопируйте сгенерированную ссылку и откройте её в браузере, выберите свой сервер и нажмите «Авторизовать».

7. **Client ID** (Application ID) скопируйте на странице **OAuth2 → General** — он нужен для `config.json` (поле `clientId`).

8. **ID гильдии (сервера):**
   - В Discord включите режим разработчика: Настройки → Расширенные → Режим разработчика (Вкл).
   - Правый клик по значку сервера → «Копировать ID сервера». Это значение — `guildId` в `config.json`.

---

## 5. Как получить ID (гильдия, каналы, роли)

Все ID в конфиге — это числа в кавычках (строки). Бот читает их именно как строки.

### Включение режима разработчика

**Настройки пользователя** → **Расширенные** → **Режим разработчика** → **Вкл.**

### ID гильдии (сервера)

- Правый клик по **названию/иконке сервера** в левом списке → **Копировать ID сервера**.  
- Это поле **`guildId`** в `config.json`.

### ID канала

- Правый клик по **названию канала** (в списке каналов) → **Копировать ID канала**.  
- Используются в секции **`channels`** (см. раздел 6 и 8).

### ID роли

- **Настройки сервера** → **Роли** → выберите роль (не @everyone) → внизу будет поле «ID» или правый клик по роли в списке (если есть пункт «Копировать ID»).  
- Либо: Настройки сервера → Роли → правый клик по названию роли в списке слева → «Копировать ID» (появляется при включённом режиме разработчика).  
- Эти ID прописываются в секции **`roles`** в `config.json`.

---

## 6. Файл config.json — полное описание

Файл лежит в **корне папки бота** и должен называться именно **`config.json`**. Кодировка — UTF-8. Формат — JSON (запятые между полями, кавычки для ключей и строк).

Пример структуры (значения замените на свои):

```json
{
    "token": "ВАШ_ТОКЕН_БОТА",
    "prefix": "/",
    "clientId": "ID_ВАШЕГО_ПРИЛОЖЕНИЯ",
    "guildId": "ID_ВАШЕГО_СЕРВЕРА",
    "channels": {
        "invite": "ID_КАНАЛА_АУДИТА_ПРИЕМА",
        "uninvite": "ID_КАНАЛА_АУДИТА_УВОЛЬНЕНИЙ",
        "uprank": "ID_КАНАЛА_АУДИТА_ПОВЫШЕНИЙ",
        "transfer": "ID_КАНАЛА_АУДИТА_ПЕРЕВОДОВ",
        "resign": "ID_КАНАЛА_РАПОРТОВ_НА_УВОЛЬНЕНИЕ",
        "promotion": "ID_КАНАЛА_ЗАПРОСОВ_НА_ПОВЫШЕНИЕ"
    },
    "roles": {
        "commands": ["ID_РОЛИ_1", "ID_РОЛИ_2"],
        "resignPromotionSubmit": ["ID_РОЛИ_SANG"],
        "resignPromotionApprove": ["ID_РОЛИ_СТАРШИЙ_СОСТАВ"],
        "inviteRoles": ["ID_РОЛИ_SANG", "ID_РОЛИ_ACADEMY"]
    }
}
```

### Поля верхнего уровня

| Поле        | Обязательное | Описание |
|------------|--------------|----------|
| **token**  | Да           | Токен бота из Discord Developer Portal → Bot → Reset Token / Copy. **Не выкладывайте в интернет.** |
| **prefix** | Нет          | Сейчас не используется (команды только слэш). Можно оставить `"/"`. |
| **clientId** | Да         | Application ID приложения из OAuth2 → General. |
| **guildId**  | Да         | ID сервера (гильдии). Команды регистрируются только на этом сервере. |
| **channels** | Да         | Объект с ID каналов (см. раздел 8). |
| **roles**    | Да         | Объект с массивами ID ролей (см. разделы 7 и 9). |

Если какого-то ключа в `channels` или `roles` нет, бот использует значения по умолчанию из кода (или пустые массивы). Лучше явно прописать все нужные каналы и роли.

---

## 7. Настройка ролей — кто что может

Вся настройка «кто какой кнопкой/командой может пользоваться» делается через секцию **`roles`** в `config.json`. Каждое поле — это **массив ID ролей** (строк в кавычках). Если у пользователя есть **хотя бы одна** из перечисленных ролей — действие разрешено.

### 7.1. `roles.commands` — кто может пользоваться слэш-командами

- **Что проверяется:** использование команд `/invite`, `/uninvite`, `/uprank`, `/downrank`, `/transfer`.
- **Формат:** массив ID ролей, например:
  ```json
  "commands": ["1466564183741956219", "1443565935008022578"]
  ```
- **Как поменять:** подставьте ID ролей, которым разрешаете кадровые команды. Можно одну роль, можно несколько.
- **Пример:** только «Старший состав»:
  ```json
  "commands": ["1466564183741956219"]
  ```
- **Пример:** добавить третью роль:
  ```json
  "commands": ["1466564183741956219", "1443565935008022578", "ЕЩЕ_ID_РОЛИ"]
  ```

Если массив пустой `[]` или ключа нет — в коде по умолчанию проверка может не выполняться (фактически доступ есть у всех, у кого есть право вызывать команды на сервере). Чтобы ограничить доступ, всегда указывайте нужные ID в `commands`.

---

### 7.2. `roles.resignPromotionSubmit` — кто может подавать рапорт на увольнение и запрос на повышение

- **Что проверяется:** нажатие кнопок «Подать заявление на увольнение» и «Запрос на повышение» в соответствующих каналах.
- **Формат:** массив ID ролей, например:
  ```json
  "resignPromotionSubmit": ["1466567326118711296"]
  ```
- **Как поменять:** укажите ID ролей, которым разрешаете подавать рапорт и запрос на повышение. Обычно это одна роль (например, SANG).
- **Пример:** разрешить двум ролям:
  ```json
  "resignPromotionSubmit": ["1466567326118711296", "ID_ВТОРОЙ_РОЛИ"]
  ```

---

### 7.3. `roles.resignPromotionApprove` — кто может одобрять и отклонять

- **Что проверяется:** кнопки «Одобрить», «Одобрить с занесением в ЧС», «Отклонить» в сообщениях рапорта на увольнение и запроса на повышение.
- **Формат:** массив ID ролей, например:
  ```json
  "resignPromotionApprove": ["1466564183741956219"]
  ```
- **Как поменять:** подставьте ID ролей «проверяющих» (например, только Старший состав или Старший состав + ещё одна роль).
- **Пример:** две роли могут одобрять:
  ```json
  "resignPromotionApprove": ["1466564183741956219", "1443565935008022578"]
  ```

---

### 7.4. Сводка по ролям

| Ключ в `config.roles`     | Где используется | Пример назначения |
|---------------------------|------------------|--------------------|
| **commands**              | Слэш-команды     | Старший состав, MA \| Военно-учебная академия |
| **resignPromotionSubmit** | Кнопки «Подать заявление» / «Запрос на повышение» | SANG |
| **resignPromotionApprove**| Кнопки «Одобрить» / «Отклонить» | Старший состав |
| **inviteRoles**           | Не «кто может», а **какие роли выдаются** при `/invite` — см. раздел 9. |

После любого изменения `config.json` нужно **перезапустить бота** (остановить и снова запустить `node bot.js` или `npm start`).

---

## 8. Настройка каналов

Секция **`channels`** в `config.json` задаёт, **в какой канал** бот отправляет сообщения. Каждое поле — один ID канала (строка).

| Ключ         | Назначение |
|--------------|------------|
| **invite**   | Сюда отправляются записи по команде `/invite` (принятие в организацию). |
| **uninvite** | Сюда отправляются записи по `/uninvite` и автоматические «увольнения» при одобрении рапорта на увольнение. |
| **uprank**   | Сюда отправляются записи по `/uprank` и автоматические «повышения» при одобрении запроса на повышение. В текущей версии сюда же идут записи по `/downrank` (понижение). |
| **transfer** | Сюда отправляются записи по `/transfer` (перевод в отдел). |
| **resign**   | Канал, где висит сообщение с кнопкой «Подать заявление на увольнение» и куда отправляются рапорты с фото и кнопками одобрения/отклонения. |
| **promotion**| Канал с кнопкой «Запрос на повышение» и куда отправляются запросы с кнопками одобрения/отклонения. |

### Как поменять канал

1. Скопируйте ID нужного канала (правый клик по каналу → Копировать ID канала).
2. В `config.json` в секции `channels` замените значение соответствующего ключа:
   ```json
   "invite": "НОВЫЙ_ID_КАНАЛА"
   ```
3. Перезапустите бота.

Несколько разных типов аудита можно вести в один и тот же канал — просто подставьте один и тот же ID в несколько ключей (например, `invite`, `uninvite`, `uprank` — один канал «кадровый-аудит»).

---

## 9. Настройка ролей при приёме (invite)

При выполнении команды **`/invite`** бот не только отправляет запись в канал аудита, но и **выдаёт выбранному пользователю роли**. Список этих ролей задаётся в `config.json` в поле **`roles.inviteRoles`**.

- **Формат:** массив ID ролей:
  ```json
  "inviteRoles": ["1466567326118711296", "1466563424308695074"]
  ```
- **Пример:** по умолчанию выдаются SANG и Academy — два ID в массиве.
- **Как поменять:**
  - Чтобы выдавать **другую роль** — замените один или оба ID на ID нужных ролей.
  - Чтобы выдавать **одну роль** — оставьте в массиве один ID:
    ```json
    "inviteRoles": ["1466567326118711296"]
    ```
  - Чтобы выдавать **три роли** — добавьте третий ID:
    ```json
    "inviteRoles": ["1466567326118711296", "1466563424308695074", "ID_ТРЕТЬЕЙ_РОЛИ"]
    ```
  - Чтобы **не выдавать никаких ролей** при приёме — укажите пустой массив:
    ```json
    "inviteRoles": []
    ```

Важно: роль бота на сервере должна быть **выше** выдаваемых ролей в списке ролей сервера, и у бота должно быть право **«Управление ролями»**. Иначе бот выдаст ошибку в ответ на команду.

После изменения `inviteRoles` перезапустите бота.

---

## 10. Использование команд

Команды вызываются слэшем в любом канале, где бот имеет право писать и где пользователь имеет право писать (и где у пользователя есть одна из ролей из `roles.commands`).

- **Ответы бота** (успех/ошибка) через несколько секунд **автоматически удаляются** — нажимать «Скрыть» не обязательно.

### /invite — принять в организацию

1. Вызвать `/invite`.
2. **Кого** — выбрать пользователя (упоминание).
3. **Номер паспорта (StaticID)** — только цифры.
4. **Причина** — необязательно; по умолчанию «Набор/Собес».
5. Отправить.

Бот выдаст пользователю роли из `inviteRoles`, отправит запись в канал `channels.invite` и напишет вам, что аудит отправлен (сообщение потом удалится).

### /uninvite — уволить

1. `/uninvite`.
2. **Кого** — выбрать пользователя.
3. **Номер паспорта** — цифры.
4. **Чёрный список** — «Да» или «Нет».
5. **Причина** — текст.
6. Отправить.

Бот **снимет все роли** у выбранного участника (кроме @everyone), отправит запись в канал `channels.uninvite`.

### /uprank — повышение

1. `/uprank`.
2. **Кого** — выбор пользователя.
3. **Номер паспорта** — цифры.
4. **Ранг** — число (1–99).
5. **Причина** — текст.
6. Отправить.

Запись уходит в канал `channels.uprank`.

### /downrank — понижение

Аналогично `/uprank`: кого, паспорт, ранг, причина. Запись в текущей версии тоже отправляется в канал `uprank` (см. ANALYTICS.md, если нужен отдельный канал для понижений).

### /transfer — перевод в отдел

1. `/transfer`.
2. **Кого** — выбор пользователя.
3. **Номер паспорта** — цифры.
4. **Из отдела** — выбор **роли** (текущий отдел).
5. **В отдел** — выбор **роли** (новый отдел).
6. **Причина** — текст.
7. Отправить.

Бот **снимает** роль «из отдела» и **выдаёт** роль «в отдел», затем отправляет запись в канал `channels.transfer`.

---

## 11. Рапорт на увольнение и запрос на повышение

### Рапорт на увольнение

- **Кто может нажать кнопку:** пользователи с одной из ролей из `roles.resignPromotionSubmit` (например, SANG).
- **Где:** канал с ID из `channels.resign`. При первом запуске бот сам отправляет туда сообщение с кнопкой «Подать заявление на увольнение» (если такого сообщения ещё нет).

**Шаги для сотрудника:**

1. Зайти в канал рапортов на увольнение.
2. Нажать «Подать заявление на увольнение».
3. В модальном окне ввести: номер паспорта (только цифры), отдел, причину увольнения.
4. Отправить форму.
5. В том же канале в течение 60 секунд отправить **одним сообщением ровно 2 фотографии** (как просит бот).
6. Появится сообщение с вашим рапортом и кнопками «Одобрить», «Одобрить с занесением в ЧС», «Отклонить». Упоминается роль Старший состав.

**Кто одобряет/отклоняет:** пользователи с одной из ролей из `roles.resignPromotionApprove` (например, Старший состав). При одобрении в канал увольнений отправляется запись (причина — ссылка на сообщение рапорта), в графе «Сотрудник» — тот, кто подал рапорт.

### Запрос на повышение

- **Кто может нажать кнопку:** роли из `roles.resignPromotionSubmit` (например, SANG).
- **Где:** канал из `channels.promotion`. Бот при запуске отправляет туда сообщение с кнопкой «Запрос на повышение», если его ещё нет.

**Шаги для сотрудника:**

1. Зайти в канал запросов на повышение.
2. Нажать «Запрос на повышение».
3. В форме ввести: номер паспорта, текущий ранг, новый ранг, ссылку на одобренный отчёт на повышение.
4. Отправить. В канал отправится сообщение с запросом и упоминанием роли Старший состав.

**Кто одобряет/отклоняет:** роли из `roles.resignPromotionApprove`. При одобрении в канал повышений автоматически отправляется запись о повышении (в причине — ссылка на сообщение запроса).

---

## 12. Частые проблемы и решение

| Проблема | Что проверить / что сделать |
|----------|-----------------------------|
| Команды не появляются в Discord | Подождать 1–2 минуты после запуска бота. Убедиться, что в `config.json` указаны верные `clientId` и `guildId`. Перезапустить бота. |
| «У вас нет прав на использование кадровых команд» | У пользователя нет ни одной роли из `roles.commands`. Добавить нужную роль пользователю или добавить ID его роли в `commands` в config. |
| «Не удалось выдать роли» / «Не удалось снять роли» | Роль бота в настройках сервера должна быть **выше** тех ролей, которые он выдаёт или снимает. Включить у бота право «Управление ролями». |
| «Канал для аудита не настроен» | В `config.json` в `channels` не указан канал для данной операции (например, `invite` или `uninvite`). Заполнить соответствующий ключ правильным ID канала. |
| «Не удалось получить данные пользователя» | Выбран пользователь, которого нет на сервере, или кэш участников не подгрузился. Выбрать участника, который точно есть на сервере. |
| Кнопки «Подать заявление» / «Запрос на повышение» не реагируют или «Подавать рапорт может только роль SANG» | У пользователя нет роли из `roles.resignPromotionSubmit`. Выдать роль или добавить ID его роли в `resignPromotionSubmit`. |
| «Одобрять может только роль Старший состав» | У нажимающего нет роли из `roles.resignPromotionApprove`. Выдать роль или добавить ID в `resignPromotionApprove`. |
| Номер паспорта не принимается | Должны быть **только цифры**, без пробелов и букв. |
| Сообщение с кнопкой в канале рапортов/запросов пропало | При следующем запуске бот проверит последние сообщения и, если своего сообщения с кнопкой не найдёт, отправит новое. Можно перезапустить бота. |

---

## 13. Безопасность (токен)

- **Токен бота** даёт полный доступ к боту. Его нельзя передавать и выкладывать в открытый доступ (например, в публичный репозиторий или скриншоты).
- Рекомендуется хранить токен не в `config.json`, а в **переменной окружения** (например, `DISCORD_TOKEN`) и в коде читать его оттуда. Тогда в репозитории можно хранить только `config.example.json` без токена и добавить `config.json` в `.gitignore`.
- Если токен мог попасть к посторонним — в Discord Developer Portal → Bot → Reset Token, затем подставить новый токен в конфиг и перезапустить бота.

---

Если нужно изменить только роли или только каналы — достаточно отредактировать **`config.json`** (секции `roles` и `channels`) и перезапустить бота. Дополнительные файлы (ROLES.md, ANALYTICS.md) носят справочный характер; бот читает только `config.json`.
